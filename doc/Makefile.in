.SUFFIXES: .dac .tex

CXX = @DACTYL_CXX@
CXXFLAGS = @DACTYL_CXXFLAGS@
CPPFLAGS = @CPPFLAGS@
DEFS = @DEFS@
LIBS = @LIBS@ -lgsl -lfftw -lm
LDFLAGS = @LDFLAGS@
INSTALL = @INSTALL@
prefix = @prefix@
# c.f. AC_ARG_PROGRAM autoconf docs:
transform=@program_transform_name@
@SET_MAKE@

VERSION = @VERSION@

all: dactyl.ps dactyl/dactyl.html preproc

###########################################################################

TEXFILES = dactyl.tex simplebands.tex polaritonbands.tex \
	polaritonbands-out/bands.eps \
	epsilon_polariton.tex epsilon_polariton.eps omniguide.tex \
	omniguide-out/bands.eps \
	superluminal_epsilon.tex superluminal_epsilon-out/eps.eps

.cpp.o:
	$(CXX) -c $(DEFS) $(CPPFLAGS) -I.. $(CXXFLAGS) $< -o $@
.o.dac: ../libdactyl.a
	$(CXX) $(CFLAGS) $(LDFLAGS) $< ../libdactyl.a $(LIBS) -o $@
.tex.cpp: preproc
	./preproc $< > $@

preproc: preproc.hs
	ghc -o preproc -package text preproc.hs

dactyl.ps : dactyl.dvi
	dvips -o dactyl.ps dactyl.dvi

dactyl/dactyl.html : $(TEXFILES)
	latex2html -split +1 -local_icons dactyl.tex

dactyl.dvi : $(TEXFILES)
	latex dactyl.tex

polaritonbands-out/bands.eps : preproc polaritonbands.dac
	rm -rf polaritonbands-out/ && ./polaritonbands.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

epsilon_polariton.eps : epsilon_polariton-out/eps.eps
	cp $< $@
epsilon_polariton-out/eps.eps : preproc epsilon_polariton.dac
	rm -rf epsilon_polariton-out/
	./epsilon_polariton.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

omniguide-out/bands.eps : preproc omniguide.dac
	rm -rf omniguide-out/*
	./omniguide.dac

superluminal_epsilon-out/eps.eps : preproc superluminal_epsilon.dac
	rm -rf superluminal_epsilon-out/*
	./superluminal_epsilon.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

test: ../libdactyl.a preproc simplebands.dac polaritonbands.dac \
	epsilon_polariton.dac omniguide.dac superluminal_epsilon.dac

doc: dactyl.ps

testclean:
	rm -rf *.o *.hi *.cpp *.dac *-out *-out-*

clean:
	rm -rf *.o *.ps *.dvi *.doc *.log *.hi *.cpp *.dac dactyl/
