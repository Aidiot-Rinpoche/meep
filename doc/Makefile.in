.SUFFIXES: .dac .tex
.PHONY: all clean

CXX = @DACTYL_CXX@
CXXFLAGS = @DACTYL_CXXFLAGS@
CPPFLAGS = @CPPFLAGS@
DEFS = @DEFS@
LIBS = @LIBS@ -lgsl -lfftw -lm
LDFLAGS = @LDFLAGS@
INSTALL = @INSTALL@
prefix = @prefix@
# c.f. AC_ARG_PROGRAM autoconf docs:
transform=@program_transform_name@
@SET_MAKE@

VERSION = @VERSION@
RUNCODE = @RUNCODE@

all: dactyl.ps dactyl/dactyl.html

###########################################################################

TEXFILES = meep.tex simplebands.tex polaritonbands.tex \
	polaritonbands-out/bands.eps \
	epsilon_polariton_1d.tex epsilon_polariton_1d-out/eps.eps \
	omniguide.tex omniguide-out/bands.eps \
	lossgain_epsilon.tex lossgain_epsilon-out/eps.eps \
	energy_cons_1d.tex energy_cons_1d-out/energy.eps \
	energy_cons.tex energy_cons-out/energy.eps \
	simple.tex simple-out/ez-000200.00.eps \
	complicated.tex complicated-out/freqs

.cpp.o: ../meep.h ../vec.h ../meep_internals.h
	$(CXX) -c $(DEFS) $(CPPFLAGS) -I.. $(CXXFLAGS) $< -o $@
.o.dac: ../libdactyl.a
	$(CXX) $(CFLAGS) $(LDFLAGS) $< ../libdactyl.a $(LIBS) -o $@
.tex.cpp:
	perl ./preproc.pl $< > $@

dactyl.ps : dactyl.dvi
	dvips -o dactyl.ps dactyl.dvi

dactyl/dactyl.html : $(TEXFILES)
	@LATEX2HTML@ -split +1 -local_icons meep.tex

dactyl.dvi : $(TEXFILES)
	latex meep.tex

simple-out/ez-000200.00.eps: simple.dac
	rm -rf simple-out/ && $(RUNCODE) ./simple.dac

complicated-out/freqs: complicated.dac
	rm -rf complicated-out/ && $(RUNCODE) ./complicated.dac

energy_cons_1d-out/energy.eps : energy_cons_1d.dac
	rm -rf energy_cons_1d-out/ && $(RUNCODE) ./energy_cons_1d.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@
energy_cons-out/energy.eps : energy_cons.dac
	rm -rf energy_cons-out/ && $(RUNCODE) ./energy_cons.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@
polaritonbands-out/bands.eps : polaritonbands.dac
	rm -rf polaritonbands-out/ && $(RUNCODE) ./polaritonbands.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

epsilon_polariton_1d-out/eps.eps : epsilon_polariton_1d.dac
	rm -rf epsilon_polariton_1d-out/
	$(RUNCODE) ./epsilon_polariton_1d.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

omniguide-out/bands.eps : omniguide.dac
	rm -rf omniguide-out/*
	$(RUNCODE) ./omniguide.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

lossgain_epsilon-out/eps.eps : lossgain_epsilon.dac
	rm -rf lossgain_epsilon-out/*
	$(RUNCODE) ./lossgain_epsilon.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

OBJFILES = omniguide.o simplebands.o epsilon_polariton_1d.o \
	polaritonbands.o lossgain_epsilon.o energy_cons.o \
	energy_cons_1d.o complicated.o
$(OBJFILES): ../libdactyl.a

test: simplebands.dac complicated.dac polaritonbands.dac \
	epsilon_polariton_1d.dac omniguide.dac lossgain_epsilon.dac \
	energy_cons_1d.dac energy_cons.dac simple.dac

doc: dactyl.ps

testclean:
	rm -rf *.o *.hi *.dac *-out *-out-*

clean:
	rm -rf *.o *.ps *.dvi *.doc *.log *.hi *.dac dactyl/
