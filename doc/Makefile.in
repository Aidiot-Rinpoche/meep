.SUFFIXES: .dac .tex
.PHONY: all clean

CXX = @DACTYL_CXX@
CXXFLAGS = @DACTYL_CXXFLAGS@
CPPFLAGS = @CPPFLAGS@
DEFS = @DEFS@
LIBS = @LIBS@ -lgsl -lfftw -lm
LDFLAGS = @LDFLAGS@
INSTALL = @INSTALL@
prefix = @prefix@
# c.f. AC_ARG_PROGRAM autoconf docs:
transform=@program_transform_name@
@SET_MAKE@

VERSION = @VERSION@

all: dactyl.ps dactyl/dactyl.html preproc

###########################################################################

TEXFILES = dactyl.tex simplebands.tex polaritonbands.tex \
	polaritonbands-out/bands.eps \
	epsilon_polariton_1d.tex epsilon_polariton_1d-out/eps.eps \
	omniguide.tex omniguide-out/bands.eps \
	lossgain_epsilon.tex lossgain_epsilon-out/eps.eps \
	energy_cons_1d.tex energy_cons_1d-out/energy.eps \
	energy_cons.tex energy_cons-out/energy.eps

.cpp.o:
	$(CXX) -c $(DEFS) $(CPPFLAGS) -I.. $(CXXFLAGS) $< -o $@
.o.dac: ../libdactyl.a
	$(CXX) $(CFLAGS) $(LDFLAGS) $< ../libdactyl.a $(LIBS) -o $@
.tex.cpp: preproc
	./preproc $< > $@

preproc: preproc.hs
	ghc -o preproc -package text preproc.hs

dactyl.ps : dactyl.dvi
	dvips -o dactyl.ps dactyl.dvi

dactyl/dactyl.html : $(TEXFILES)
	latex2html -split +1 -local_icons dactyl.tex

dactyl.dvi : $(TEXFILES)
	latex dactyl.tex

energy_cons_1d-out/energy.eps : preproc energy_cons_1d.dac
	rm -rf energy_cons_1d-out/ && ./energy_cons_1d.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@
energy_cons-out/energy.eps : preproc energy_cons.dac
	rm -rf energy_cons-out/ && ./energy_cons.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@
polaritonbands-out/bands.eps : preproc polaritonbands.dac
	rm -rf polaritonbands-out/ && ./polaritonbands.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

epsilon_polariton_1d-out/eps.eps : preproc epsilon_polariton_1d.dac
	rm -rf epsilon_polariton_1d-out/
	./epsilon_polariton_1d.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

omniguide-out/bands.eps : preproc omniguide.dac
	rm -rf omniguide-out/*
	./omniguide.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

lossgain_epsilon-out/eps.eps : preproc lossgain_epsilon.dac
	rm -rf lossgain_epsilon-out/*
	./lossgain_epsilon.dac
	mv $@ $@-tmp
	sed -e 's/fill//' $@-tmp > $@

OBJFILES = omniguide.o simplebands.o epsilon_polariton_1d.o \
	polaritonbands.o lossgain_epsilon.o energy_cons.o \
	energy_cons_1d.o
$(OBJFILES): ../libdactyl.a

test: preproc simplebands.dac polaritonbands.dac \
	epsilon_polariton_1d.dac omniguide.dac lossgain_epsilon.dac \
	energy_cons_1d.dac energy_cons.dac

doc: dactyl.ps

testclean:
	rm -rf *.o *.hi *.cpp *.dac *-out *-out-*

clean:
	rm -rf *.o *.ps *.dvi *.doc *.log *.hi *.cpp *.dac dactyl/
