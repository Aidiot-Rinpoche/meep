.SUFFIXES: .dac
.PHONY: doc clean all test check uninstall bench

CXX = @DACTYL_CXX@
CXXFLAGS = @DACTYL_CXXFLAGS@
CPPFLAGS = @CPPFLAGS@
DEFS = @DEFS@
LIBS = @LIBS@ -lgsl -lfftw -lm
LDFLAGS = @LDFLAGS@
INSTALL = @INSTALL@
prefix = @prefix@
# c.f. AC_ARG_PROGRAM autoconf docs:
transform=@program_transform_name@
@SET_MAKE@

VERSION = @VERSION@
package = dactyl
distdir = $(package)-$(VERSION)

###########################################################################

OBJ_dactyl = step.o harminv.o bands.o output_directory.o material.o \
	polarization.o monitor.o control_c.o grace.o energy_and_flux.o \
	vec.o slices.o initialize.o sources.o fields.o boundaries.o \
	mympi.o fluxes.o time.o
OBJ_example = example.o libdactyl.a

###########################################################################

all: libdactyl.a example
install: dactyl-install
uninstall: dactyl-uninstall

###########################################################################

$(OBJ_dactyl): dactyl.h dactyl_internals.h vec.h mympi.h
example.o: example.cpp dactyl.h vec.h mympi.h
step.o: step.cpp step_h.h dactyl.h dactyl_internals.h vec.h mympi.h

step_h.h: step_h.hs StepGen.lhs
	ghc -fglasgow-exts --make -o step_h step_h.hs && ./step_h > step_h.h

libdactyl.a: $(OBJ_dactyl)
	ar cru libdactyl.a $(OBJ_dactyl)
	ranlib libdactyl.a

example: $(OBJ_example)
	$(CXX) $(CFLAGS) $(LDFLAGS) $(OBJ_example) $(LIBS) -o $@

bands_example: bands_example.o libdactyl.a
	$(CXX) $(CFLAGS) $(LDFLAGS) bands_example.o libdactyl.a $(LIBS) -o $@

convergence_testing: convergence_testing.o libdactyl.a
	$(CXX) $(CFLAGS) $(LDFLAGS) convergence_testing.o libdactyl.a $(LIBS) -o $@

.cpp.o:
	$(CXX) -c $(DEFS) $(CPPFLAGS) $(CXXFLAGS) $< -o $@
.o.dac: libdactyl.a
	$(CXX) $(CFLAGS) $(LDFLAGS) $< libdactyl.a $(LIBS) -o $@

###########################################################################

dactyl-install: dactyl
	$(INSTALL) -d $(prefix)/bin
	$(INSTALL) -d $(prefix)/man/man1
	$(INSTALL) -m 0755 -s dactyl $(prefix)/bin/`echo dactyl|sed '$(transform)'`
	$(INSTALL) -m 0644 dactyl.1 $(prefix)/man/man1

dactyl-uninstall:
	rm -f $(prefix)/bin/dactyl
	rm -f $(prefix)/man/man1/dactyl.1

###########################################################################

uninstall: $(UNINSTALL_TARGETS)

dist:
	darcs dist -d $(VERSION)

bench: libdactyl.a
	cd tests && make bench

test: libdactyl.a
	cd doc && make test
	cd tests && make test

test_d_k_0.1pi_pml_m_1: diff_slice d_k_0.1pi_pml_m_1.dac
	rm -rf d_k_0.1pi_pml_m_1-out
	./d_k_0.1pi_pml_m_1.dac
	cp reference_slices/d_k_0.1pi_pml_m_1-out/*.sli d_k_0.1pi_pml_m_1-out/
	cd d_k_0.1pi_pml_m_1-out/ && \
	    ../diff_slice d_k_0.1pi_pml_m_1-out M_k_0.1pi_pml_m_1 1e-5

doc : documentation

documentation: libdactyl.a
	cd doc && make

clean:
	rm -f $(OBJ_dactyl) *.o libdactyl.a example core bands_example *.dac debug_out_*
	cd doc && make clean
	cd tests && make clean

distclean: clean
	rm -f config.cache Makefile config.log config.status config.h dactyl

maintainer-clean: distclean
	rm -f configure config.h
